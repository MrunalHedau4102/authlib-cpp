name: C++ Tests (Pull Requests Only)

on:
  push:
    branches: [ develop ]
    paths:
      - 'authlib-cpp/**'
      - '!authlib-cpp/README.md'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'authlib-cpp/**'
      - '!authlib-cpp/README.md'

jobs:
  test:
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ ubuntu-latest, macos-latest, windows-latest ]
        compiler: [ gcc, clang ]
        exclude:
          # Reduce matrix size - exclude some combinations
          - os: windows-latest
            compiler: clang
          - os: macos-latest
            compiler: gcc
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libssl-dev \
            libsqlite3-dev \
            nlohmann-json3-dev \
            git
      
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake openssl sqlite nlohmann-json pkg-config
      
      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install cmake openssl sqlite -y
      
      - name: Install Google Test
        run: |
          git clone https://github.com/google/googletest.git googletest-repo
          cd googletest-repo
          mkdir build && cd build
          cmake ..
          cmake --build .
          cmake --install .
      
      - name: Create build directory
        working-directory: ./authlib-cpp
        run: mkdir -p build
      
      - name: Configure CMake (Unix)
        if: runner.os != 'Windows'
        working-directory: ./authlib-cpp/build
        run: |
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_TESTING=ON \
            -DCMAKE_CXX_COMPILER=${{ matrix.compiler }}
      
      - name: Configure CMake (Windows)
        if: runner.os == 'Windows'
        working-directory: ./authlib-cpp/build
        run: |
          cmake .. `
            -DCMAKE_BUILD_TYPE=Release `
            -DENABLE_TESTING=ON
      
      - name: Build
        working-directory: ./authlib-cpp/build
        run: cmake --build . --config Release
      
      - name: Run tests
        working-directory: ./authlib-cpp/build
        run: ctest --output-on-failure --verbose
      
      - name: Run integration tests
        working-directory: ./authlib-cpp/build
        run: ./authlib_tests --gtest_print_time=1
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: cpp-test-results-${{ matrix.os }}-${{ matrix.compiler }}
          path: |
            authlib-cpp/build/test_results.xml
            authlib-cpp/build/CMakeFiles/
          retention-days: 30

  static-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cppcheck \
            clang-tools \
            cmake \
            build-essential
      
      - name: Run cppcheck
        working-directory: ./authlib-cpp
        continue-on-error: true
        run: |
          cppcheck --enable=all \
            --suppress=missingIncludeSystem \
            --std=c++17 \
            include/ src/ tests/
      
      - name: Setup clang-tidy
        run: sudo apt-get install -y clang-tidy
      
      - name: Create build directory
        working-directory: ./authlib-cpp
        run: mkdir -p build
      
      - name: Configure with clang-tidy
        working-directory: ./authlib-cpp/build
        continue-on-error: true
        run: |
          cmake .. \
            -DCMAKE_CXX_CLANG_TIDY="clang-tidy;-checks=*,-fuchsia-*" \
            -DCMAKE_BUILD_TYPE=Debug
      
      - name: Run static analysis
        working-directory: ./authlib-cpp/build
        continue-on-error: true
        run: cmake --build . --target clang-tidy 2>&1 | head -100
